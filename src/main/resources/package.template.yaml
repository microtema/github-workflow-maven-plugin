package:
  name: Package
  runs-on: [ %RUNS_ON% ]
  needs: [ build ]
  steps:
    - name: 'Artifact: download'
      uses: actions/download-artifact@v2
      with:
        name: target-artifact
    - name: 'Maven versions:get'
      run: export VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout $MAVEN_CLI_OPTS | tail -n 1)
    - name: 'Docker: login'
      run: docker login -u $DOCKER_REGISTRY_USER -p $DOCKER_REGISTRY_PASSWORD $DOCKER_REGISTRY
    - name: 'Docker: build'
      run: mvn jib:dockerBuild -Dimage=$DOCKER_REGISTRY/$APP_NAME -Djib.to.tags=$VERSION.$GITHUB_SHA $MAVEN_CLI_OPTS
    - name: 'Docker: push'
      run: docker build -t docker push $DOCKER_REGISTRY/$APP_NAME:$VERSION.$GITHUB_SHA
